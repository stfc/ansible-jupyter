---
- name: Validate instance_type is provided and valid
  ansible.builtin.fail:
    msg: "Error: The 'instance_type' variable must be provided and must be one of: {{ environments.keys() | join(', ') }}"
  when:
    - instance_type is not defined or instance_type == ''
    - instance_type not in environments

# This task effectively "creates" the config variable by ensuring it's accessible
# based on the validated instance_type. No explicit action is needed beyond this
# as variables are resolved during playbook execution.
- name: Set config variable based on instance_type
  ansible.builtin.set_fact:
    config: "{{ environments[instance_type] }}"
  # This task will only run if the validation above passes.
  # The 'config' variable will now be available for subsequent tasks or playbooks
  # that include this one or are run in the same context.
